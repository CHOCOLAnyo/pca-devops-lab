# =====================================================================================================
# æª”æ¡ˆåç¨±ï¼š.github/workflows/deploy.yml
# å°ˆæ¡ˆåç¨±ï¼šPCA DevOps Exam - SRE Observability & Alerting
# æ ¸å¿ƒåƒ¹å€¼ï¼šè½å¯¦ Infrastructure as Code (IaC) èˆ‡è‡ªå‹•åŒ–éƒ¨ç½²ï¼Œçµåˆå³æ™‚å‘Šè­¦ç›£æ§ã€‚
# =====================================================================================================

name: PCA DevOps Exam Pipeline (Final Alerting)     # [å·¥ä½œæµåç¨±] å®šç¾©æ­¤ CI/CD åœ¨ GitHub ç®¡ç†ä»‹é¢çš„é¡¯ç¤ºæŠ¬é ­

# [è§¸ç™¼æ¢ä»¶è¨­å®š]ï¼šå®šç¾©è‡ªå‹•åŒ–æµæ°´ç·šä½•æ™‚é–‹å§‹é‹ä½œ
on:                                                  # [è§¸ç™¼] ç›£è½äº‹ä»¶çš„å•Ÿå‹•é»
  push:                                              # [æ¨é€äº‹ä»¶] ç•¶æœ‰ç¨‹å¼ç¢¼æ¨é€åˆ° GitHub æ™‚
    branches: [ "main" ]                             # [åˆ†æ”¯éæ¿¾] åƒ…é™ main åˆ†æ”¯çš„æ¨é€ï¼Œä¿è­·ç”Ÿç”¢ç’°å¢ƒç©©å®šæ€§
  workflow_dispatch:                                  # [æ‰‹å‹•è§¸ç™¼] åœ¨ GitHub Web UI æä¾›æŒ‰éˆ•ï¼Œå…è¨±äººå·¥å•Ÿå‹•æµç¨‹

# [å…¨åŸŸç’°å¢ƒè®Šæ•¸]ï¼šé›†ä¸­ç®¡ç†é›²ç«¯è³‡æºåƒæ•¸ï¼Œå¯¦ç¾ã€Œä¸€æ¬¡å®šç¾©ï¼Œå…¨åŸŸç”Ÿæ•ˆã€
env:                                                 # [ç’°å¢ƒå€å¡Š] å®£å‘Šè·¨ Job ä½¿ç”¨çš„è®Šæ•¸
  PROJECT_ID: danny-pca-lab                          # [GCP] å°ˆæ¡ˆå”¯ä¸€æ¨™è­˜ç¬¦ï¼Œç”¨æ–¼èº«åˆ†èªè­‰èˆ‡è³‡æºæ¨™ç±¤
  GKE_CLUSTER: pca-cluster                           # [GKE] ç›®æ¨™ Kubernetes å¢é›†åç¨±
  GKE_ZONE: asia-east1-a                             # [GKE] å¢é›†æ‰€åœ¨çš„å€åŸŸ
  IMAGE_NAME: flask-app                              # [Docker] æ˜ åƒæª”åŸºç¤åç¨±ï¼Œç”¨æ–¼å»ºæ§‹èˆ‡å­˜å„²
  REPO_NAME: pca-repo                                # [Registry] Artifact Registry çš„å­˜å„²åº«åç¨±
  REGION: asia-east1                                 # [GCP] åœ°ç†å€åŸŸï¼Œæ±ºå®šæœå‹™éƒ¨ç½²çš„ç‰©ç†ä½ç½®

jobs:                                                # [ä»»å‹™å€å¡Š] å®£å‘Šæµæ°´ç·šåŒ…å«çš„ç¨ç«‹ä½œæ¥­å–®å…ƒ
  # =================================================================================================
  # Job 1: åŸºç¤è¨­æ–½æº–å‚™ (Setup Infrastructure)
  # [SRE è€ƒé»]ï¼šIaC (Terraform) èˆ‡é…ç½®ç®¡ç† (Ansible) çš„æ·±åº¦æ•´åˆ
  # =================================================================================================
  setup-infrastructure:                               # [ä»»å‹™ ID] åŸºç¤è¨­æ–½æº–å‚™
    name: Setup Infra & Config                       # [ä»»å‹™åç¨±] é¡¯ç¤ºåœ¨æµç¨‹åœ–ä¸­çš„æ¨™ç±¤
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨] ä½¿ç”¨ GitHub æä¾›ä¹‹æœ€æ–° Ubuntu è™›æ“¬ç’°å¢ƒ
    steps:                                           # [æ­¥é©Ÿæ¸…å–®] ä»»å‹™å…§å…·é«”çš„æ“ä½œæµç¨‹
      - name: Checkout Code                          # [æ­¥é©Ÿæ¨™é¡Œ] ç²å–åŸå§‹ç¢¼
        uses: actions/checkout@v3                    # [ uses ] å¼•ç”¨å®˜æ–¹å·¥å…·ï¼šå°‡ç•¶å‰ GitHub å€‰åº«çš„ä»£ç¢¼ä¸‹è¼‰åˆ°åŸ·è¡Œæ©Ÿ

      - name: Authenticate to GCP                    # [æ­¥é©Ÿæ¨™é¡Œ] ç™»å…¥ Google Cloud
        uses: google-github-actions/auth@v1          # [ uses ] å¼•ç”¨ GCP å®˜æ–¹å·¥å…·ï¼šåŸ·è¡Œèº«åˆ†é©—è­‰
        with:                                        # [ with ] å‚³å…¥è©²å·¥å…·æ‰€éœ€çš„åƒæ•¸
          credentials_json: ${{ secrets.GCP_SA_KEY }} # [åƒæ•¸] å¼•ç”¨ GitHub Secrets ä¸­åŠ å¯†çš„ GCP é‡‘é‘°

      - name: Setup Terraform                        # [æ­¥é©Ÿæ¨™é¡Œ] é…ç½® Terraform ç’°å¢ƒ
        uses: hashicorp/setup-terraform@v2           # [ uses ] å¼•ç”¨å®˜æ–¹å·¥å…·ï¼šå®‰è£ä¸¦é…ç½® Terraform åŸ·è¡Œç’°å¢ƒ
        with:                                        # [ with ] å‚³å…¥å·¥å…·åƒæ•¸
          terraform_version: 1.5.7                   # [åƒæ•¸] é–å®š Terraform ç‰ˆæœ¬ï¼Œç¢ºä¿ IaC ç’°å¢ƒä¸€è‡´æ€§

      - name: Terraform Apply                        # [æ­¥é©Ÿæ¨™é¡Œ] å»ºç«‹é›²ç«¯åŸºç¤è¨­æ–½
        run: |                                       # [ run ] åŸ·è¡Œ Linux æŒ‡ä»¤è…³æœ¬
          cd terraform                               # åˆ‡æ›è‡³ Terraform è…³æœ¬æ‰€åœ¨ç›®éŒ„
          terraform init                             # åˆå§‹åŒ– Backend ç‹€æ…‹èˆ‡ Provider æ’ä»¶
          terraform apply -auto-approve              # åŸ·è¡Œéƒ¨ç½²ä¸¦å¼·åˆ¶æ‰¹å‡†è®Šæ›´ï¼Œå¯¦ç¾å…¨è‡ªå‹•ç„¡äººå€¼å®ˆ
        env:                                         # [ env ] åœ¨æ­¥é©Ÿå…§æ³¨å…¥ç’°å¢ƒè®Šæ•¸
          GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }} # è³¦äºˆ Terraform éƒ¨ç½²é›²ç«¯è³‡æºçš„æ¬Šé™

      - name: Get GKE Credentials                    # [æ­¥é©Ÿæ¨™é¡Œ] ç²å–å¢é›†æ“ä½œæ¬Šé™
        uses: google-github-actions/get-gke-credentials@v1 # [ uses ] å¼•ç”¨å®˜æ–¹å·¥å…·ï¼šå°‡ GKE æ†‘è­‰å¯«å…¥æœ¬åœ° kubeconfig
        with:                                        # [ with ] å‚³å…¥åƒæ•¸
          cluster_name: ${{ env.GKE_CLUSTER }}       # [åƒæ•¸] ç›®æ¨™å¢é›†åç¨±
          location: ${{ env.GKE_ZONE }}              # [åƒæ•¸] ç›®æ¨™å¢é›†å€åŸŸ

      - name: Run Ansible Playbook                   # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œé…ç½®ç®¡ç†èˆ‡ç›£æ§çµ„ä»¶åˆå§‹åŒ–
        # [SRE ä¿®æ­£]ï¼šæŒ‡å®šå·¥ä½œç›®éŒ„ç‚º ansible è³‡æ–™å¤¾ï¼Œé¿å…è·¯å¾‘è§£æè¡çª
        working-directory: ./ansible
        run: |                                       # [ run ] åŸ·è¡Œè…³æœ¬
          pip install ansible kubernetes             # å®‰è£ Ansible èˆ‡ K8s é€£å‹•æ‰€éœ€çš„ Python å¥—ä»¶
          # [ä¿®æ­£]ï¼šç§»é™¤è·¯å¾‘ä¸­çš„ ansible/ å‰ç¶´ï¼Œå› ç‚ºå·²åœ¨ working-directory å…§
          ansible-galaxy install -r requirements.yml 
          # [ä¿®æ­£]ï¼šç§»é™¤çºŒæ¥ç¬¦è™Ÿ \ å¾Œæ–¹çš„è¨»è§£ï¼Œç¢ºä¿ Shell æŒ‡ä»¤é€£çºŒæ€§
          ansible-playbook k8s_init.yml \
            -e "telegram_token=${{ secrets.TG_TOKEN }}" \
            -e "telegram_chat_id=${{ secrets.TG_CHAT_ID }}"
        env:                                         # [ env ]
          ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3 # å¼·åˆ¶æŒ‡å®š Python3 ä½œç‚º Ansible æŒ‡ä»¤å™¨

      - name: Pre-Deploy Services for IPs            # [æ­¥é©Ÿæ¨™é¡Œ] é éƒ¨ç½² Service ä»¥ç²å–å›ºå®š IP
        run: |                                       # [ run ]
          kubectl apply -f k8s/service.yaml          # éƒ¨ç½²æ‡‰ç”¨æœå‹™ï¼Œå‘ GCP ç”³è«‹ LoadBalancer IP
          kubectl apply -f k8s/monitoring/grafana.yaml # éƒ¨ç½²ç›£æ§æœå‹™
          sleep 20                                   # å»¶é² 20 ç§’ï¼Œç¢ºä¿ LoadBalancer åˆ†é…å…¬ç¶² IP å®Œç•¢

      - name: Notify Telegram (Ready to Review)      # [æ­¥é©Ÿæ¨™é¡Œ] åŸºç¤è¨­æ–½å°±ç·’é€šçŸ¥
        if: success()                                # [ if ] åƒ…åœ¨ä¸Šè¿°æ­¥é©Ÿã€Œå…¨éƒ¨æˆåŠŸã€æ™‚æ‰åŸ·è¡Œ
        env:                                         # [ env ] æ³¨å…¥é€šè¨Šåƒæ•¸
          TG_TOKEN: ${{ secrets.TG_TOKEN }}          # Telegram Token
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}      # Telegram Chat ID
        run: |                                       # [ run ]
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "Pending")
          GRAFANA_IP=$(kubectl get svc grafana-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "Pending")
          MSG="âœ… [Infra Ready] åŸºç¤å»ºè¨­å°±ç·’ï¼%0AğŸŒ ç¶²ç«™: http://${APP_IP}%0AğŸ“Š Grafana: http://${GRAFANA_IP}%0Aç¢ºèªå¾Œè«‹é€²è¡Œå¯©æ ¸ã€‚"
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG"

      - name: Notify Telegram (Job 1 Failed)         # [æ­¥é©Ÿæ¨™é¡Œ] æ•…éšœå‘Šè­¦ (Job 1 å¤±æ•—)
        if: failure()                                # [ if ] æ ¸å¿ƒå‘Šè­¦é‚è¼¯ï¼šè‹¥ä¸Šè¿°ä»»ä¸€æ­¥é©Ÿå¤±æ•—å‰‡å•Ÿå‹•
        env:                                         # [ env ]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [ run ]
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
          -d chat_id="${TG_CHAT_ID}" \
          -d text="âŒ [Alert] Job 1 (åŸºç¤è¨­æ–½) éƒ¨ç½²å¤±æ•—ï¼%0Aè«‹æª¢æŸ¥ GitHub Actions ç´€éŒ„ã€‚"

  # =================================================================================================
  # Job 2: é‡‘çµ²é›€éƒ¨ç½² (Deploy Canary)
  # [SRE è€ƒé»]ï¼šé‡‘çµ²é›€æ¸¬è©¦ (Canary Test) èˆ‡ CI å®¹å™¨åŒ–æµç¨‹
  # =================================================================================================
  deploy-canary:                                     # [ä»»å‹™ ID] é‡‘çµ²é›€ç™¼ä½ˆéšæ®µ
    name: Build & Release Canary                     # [ä»»å‹™åç¨±]
    needs: setup-infrastructure                      # [ needs ] ç›¸ä¾æ€§ï¼šå¿…é ˆ Job 1 æˆåŠŸï¼Œæ­¤ä»»å‹™æ‰æœƒé–‹å§‹
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨] Ubuntu
    environment: canary-release                      # [ environment ] å•Ÿç”¨ GitHub æ ¸å‡†é–˜é–€ï¼šéœ€äººå·¥æ ¸å‡†æ‰å•Ÿå‹•æ­¤ Job

    steps:                                           # [æ­¥é©Ÿæ¸…å–®]
      - name: Checkout Code                          # ä¸‹è¼‰å°ˆæ¡ˆåŸå§‹ç¢¼
        uses: actions/checkout@v3                    # ä¸‹è¼‰å…§å®¹

      - name: Authenticate to GCP                    # GCP æ¬Šé™èªè­‰
        uses: google-github-actions/auth@v1          # èªè­‰å·¥å…·
        with:                                        # åƒæ•¸è¼¸å…¥
          credentials_json: ${{ secrets.GCP_SA_KEY }} # å‚³å…¥é‡‘é‘°

      - name: Configure Docker                       # [æ­¥é©Ÿæ¨™é¡Œ] èªè­‰ Docker Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev # æˆæ¬Š Docker æ¨é€è‡³ Artifact Registry

      - name: Generate SHA Tag                       # [æ­¥é©Ÿæ¨™é¡Œ] ç”Ÿæˆç‰ˆæœ¬æ¨™ç±¤
        id: get_tag                                  # [ id ] ç‚ºæ­¤æ­¥é©Ÿè¨­å®šè­˜åˆ¥ç¢¼ï¼Œä¾›å¾ŒçºŒæ­¥é©Ÿè®€å–
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT # æå– Git Hash çŸ­ç¢¼

      - name: Build and Push                         # [æ­¥é©Ÿæ¨™é¡Œ] æ˜ åƒæª”å°è£èˆ‡ä¸Šå‚³
        env:                                         # [ env ]
          SHA: ${{ steps.get_tag.outputs.sha_short }} # å¼•ç”¨ get_tag æ­¥é©Ÿç”¢ç”Ÿçš„ Hash
        run: |                                       # [ run ]
          FULL_IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}"
          docker build -t ${FULL_IMAGE_PATH}:${SHA} -t ${FULL_IMAGE_PATH}:v2 . # å»ºæ§‹æ˜ åƒæª”ä¸¦æ¨™è¨˜ç‰ˆæœ¬
          docker push ${FULL_IMAGE_PATH}:${SHA}      # æ¨é€å”¯ä¸€ç‰ˆæœ¬æ˜ åƒæª”
          docker push ${FULL_IMAGE_PATH}:v2           # æ¨é€æ­£å¼ç‰ˆæœ¬æ˜ åƒæª”

      - name: Get GKE Credentials                    # ç²å–å¢é›†æ§åˆ¶æ¬Š
        uses: google-github-actions/get-gke-credentials@v1 # æ›´æ–°æ†‘è­‰
        with:                                        # åƒæ•¸
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Debug K8s Directory                    # [æ­¥é©Ÿæ¨™é¡Œ] éƒ¨ç½²å‰æª¢æŸ¥ (é™¤éŒ¯ç”¨)
        run: |                                       # [ run ]
          echo "==== ç›®å‰ k8s è³‡æ–™å¤¾ä¸‹çš„æª”æ¡ˆæ¸…å–® ===="
          ls -R k8s/                                 # åˆ—å‡ºæª”æ¡ˆï¼Œç¢ºä¿ YAML æª”æ¡ˆè·¯å¾‘æ­£ç¢º

      - name: Deploy Canary Only                     # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œé‡‘çµ²é›€ç™¼ä½ˆ
        run: |                                       # [ run ]
          kubectl apply -f k8s/redis.yaml            # ç¢ºä¿è³‡æ–™åº«é‹è¡Œ
          kubectl apply -f k8s/service.yaml          # ç¢ºä¿ Service é…ç½®åŒæ­¥
          kubectl apply -f k8s/canary-deployment.yaml # éƒ¨ç½²é‡‘çµ²é›€æ¸¬è©¦ç‰ˆ Pod
          kubectl rollout restart deployment pca-app-canary -n pca-app-ns # å¼·åˆ¶æ›´æ–° Pod ä»¥å¥—ç”¨æ–°æ˜ åƒæª”

      - name: Notify Telegram (Canary Released)       # [æ­¥é©Ÿæ¨™é¡Œ] é‡‘çµ²é›€ä¸Šç·šå‘Šè­¦
        if: success()                                # æˆåŠŸæ™‚ç™¼é€
        env:                                         # æ³¨å…¥é€šè¨Šåƒæ•¸
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [ run ]
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          MSG="ğŸ¤ [Canary Live] é‡‘çµ²é›€ä¸Šç·šï¼%0AğŸŒ ç¶²ç«™: http://${APP_IP}%0Aè«‹æ¸¬è©¦å¾Œé€²è¡Œæœ€çµ‚æ ¸å‡†ã€‚"
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG"

      - name: Notify Telegram (Job 2 Failed)         # [æ­¥é©Ÿæ¨™é¡Œ] æ•…éšœå‘Šè­¦ (Job 2 å¤±æ•—)
        if: failure()                                # æ‰“åŒ…æˆ–éƒ¨ç½²å¤±æ•—æ™‚å•Ÿå‹•
        env:                                         # [ env ]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [ run ]
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
          -d chat_id="${TG_CHAT_ID}" \
          -d text="âŒ [Alert] Job 2 (é‡‘çµ²é›€éƒ¨ç½²) å¤±æ•—ï¼%0Aå¯èƒ½æ˜¯ YAML æª”åéŒ¯èª¤æˆ– Docker æ‰“åŒ…å¤±æ•—ã€‚"

  # =================================================================================================
  # Job 3: å…¨é¢åˆ‡æ› (Full Rollout)
  # [SRE è€ƒé»]ï¼šè—ç¶ éƒ¨ç½² (Blue-Green) åˆ‡æ›èˆ‡æµé‡ç²¾ç¢ºæ§åˆ¶
  # =================================================================================================
  full-rollout:                                      # [ä»»å‹™ ID] å…¨é¢åˆ‡æ›
    name: Approval & Full Rollout                    # [ä»»å‹™åç¨±]
    needs: deploy-canary                             # [ç›¸ä¾æ€§] å¿…é ˆå…ˆé€šéé‡‘çµ²é›€æ ¸å‡†ï¼Œæ‰å¯åŸ·è¡Œå…¨é¢åˆ‡æ›
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨] Ubuntu
    environment: production                          # [ environment ] ç”Ÿç”¢ç’°å¢ƒæ ¸å‡†é–€æª»ï¼šéœ€äººå·¥å†æ¬¡æ ¸å‡†

    steps:                                           # [æ­¥é©Ÿæ¸…å–®]
      - name: Checkout Code                          # ä¸‹è¼‰å°ˆæ¡ˆä»£ç¢¼
        uses: actions/checkout@v3                    # ä¸‹è¼‰

      - name: Authenticate to GCP                    # GCP æ¬Šé™èªè­‰
        uses: google-github-actions/auth@v1          # å®˜æ–¹å·¥å…·
        with:                                        # åƒæ•¸
          credentials_json: ${{ secrets.GCP_SA_KEY }} # å‚³å…¥é‡‘é‘°

      - name: Get GKE Credentials                    # ç²å–å¢é›†é€£ç·šæ†‘è­‰
        uses: google-github-actions/get-gke-credentials@v1 # æ›´æ–°æ†‘è­‰
        with:                                        # åƒæ•¸
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Full Rollout (v2)                      # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œæ­£å¼ç‰ˆå…¨é¢éƒ¨ç½²èˆ‡åˆ‡æ›
        run: |                                       # [ run ]
          kubectl apply -f k8s/app-green.yaml        # éƒ¨ç½²æ­£å¼çš„ v2 ç©©å®šç‰ˆ Pod
          kubectl apply -f k8s/service.yaml          # åŒæ­¥æœå‹™å®šç¾©æª”æ¡ˆ
          # åˆ©ç”¨ kubectl patch ç¬é–“ä¿®æ”¹ Service çš„æ¨™ç±¤é¸å–å™¨ï¼Œå°‡ 100% æµé‡å°å‘ v2
          kubectl patch svc pca-app-service -n pca-app-ns -p "{\"spec\":{\"selector\":{\"version\":\"v2\"}}}"
          # [æ¸…ç†æ©Ÿåˆ¶]ï¼šåˆ‡æ›æˆåŠŸå¾Œï¼Œåˆªé™¤ä¸å†éœ€è¦çš„æš«æ™‚æ€§é‡‘çµ²é›€éƒ¨ç½²ï¼Œå›æ”¶é‹ç®—è³‡æº
          kubectl delete -f k8s/canary-deployment.yaml --ignore-not-found=true

      - name: Notify Telegram (Success)               # [æ­¥é©Ÿæ¨™é¡Œ] æœ€çµ‚æˆåŠŸå–œå ±
        if: success()                                # æœ€çµ‚æˆåŠŸæ™‚ç™¼é€
        env:                                         # [ env ] æ³¨å…¥åƒæ•¸
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [ run ]
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          MSG="ğŸš€ [Full Rollout] 100% åˆ‡æ›å®Œæˆï¼%0AğŸŒ æ­£å¼ç¶²å€: http://${APP_IP}"
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG"

      - name: Notify Telegram (Job 3 Failed)         # [æ­¥é©Ÿæ¨™é¡Œ] æ•…éšœå‘Šè­¦ (Job 3 å¤±æ•—)
        if: failure()                                # æœ€å±æ€¥çš„å‘Šè­¦ï¼šç”Ÿç”¢ç’°å¢ƒåˆ‡æ›å¤±æ•—
        env:                                         # [ env ]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [ run ]
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
          -d chat_id="${TG_CHAT_ID}" \
          -d text="âŒ [Alert] Job 3 (å…¨é¢åˆ‡æ›) å¤±æ•—ï¼%0Aç”Ÿç”¢ç’°å¢ƒç›®å‰æµé‡å¯èƒ½ä¸æ­£å¸¸ï¼Œè«‹ç«é€Ÿæ‰‹å‹•è™•ç†ï¼"