# ===================================================================================================== # [å€éš”ç·š] æª”æ¡ˆé–‹é ­
# æª”æ¡ˆåç¨±ï¼š.github/workflows/deploy.yml                                                                # [å‚™è¨»] å®šç¾©æª”æ¡ˆæ–¼å°ˆæ¡ˆä¸­çš„è·¯å¾‘
# å°ˆæ¡ˆåç¨±ï¼šPCA DevOps Exam - SRE Observability & Alerting                                              # [å‚™è¨»] å°ˆæ¡ˆå°ˆå±¬åç¨±
# æ ¸å¿ƒåƒ¹å€¼ï¼šè½å¯¦ IaCã€è‡ªå‹•åŒ–éƒ¨ç½²ã€CI/CD æ˜ åƒæª”é å»ºæ§‹ã€ä»¥åŠå³æ™‚ Telegram å‘Šè­¦ã€‚                           # [å‚™è¨»] å®šç¾©è‡ªå‹•åŒ–æ ¸å¿ƒç›®æ¨™
# ===================================================================================================== # [å€éš”ç·š] æ¨™é ­çµå°¾

name: PCA DevOps Exam Pipeline (Final Alerting)     # [å·¥ä½œæµåç¨±] å®šç¾©æ­¤ CI/CD åœ¨ GitHub Actions ä»‹é¢çš„æŠ¬é ­

on:                                                  # [è§¸ç™¼å€å¡Š] å®šç¾©è‡ªå‹•åŒ–æµç¨‹çš„å•Ÿå‹•æ™‚æ©Ÿ
  push:                                              # [äº‹ä»¶] ç•¶æœ‰ç¨‹å¼ç¢¼æ¨é€åˆ° GitHub å€‰åº«æ™‚
    branches: [ "main" ]                             # [éæ¿¾] åƒ…é™æ–¼æ¨é€åˆ° main åˆ†æ”¯æ™‚æ‰å•Ÿå‹•
  workflow_dispatch:                                  # [æ‰‹å‹•åŠŸèƒ½] å…è¨±ä½¿ç”¨è€…åœ¨ GitHub ç¶²é ä¸Šæ‰‹å‹•é»æ“Šå•Ÿå‹•æŒ‰éˆ•

env:                                                 # [ç’°å¢ƒå€å¡Š] å®šç¾©å…¨åŸŸé€šç”¨çš„è®Šæ•¸
  PROJECT_ID: danny-pca-lab                          # [è®Šæ•¸] GCP å°ˆæ¡ˆçš„ ID æ¨™è­˜ç¬¦
  GKE_CLUSTER: pca-cluster                           # [è®Šæ•¸] ç›®æ¨™ GKE å¢é›†çš„åç¨±
  GKE_ZONE: asia-east1-a                             # [è®Šæ•¸] GKE å¢é›†éƒ¨ç½²çš„å…·é«”å€åŸŸ
  IMAGE_NAME: flask-app                              # [è®Šæ•¸] Docker æ˜ åƒæª”çš„åŸºç¤åç¨±
  REPO_NAME: pca-repo                                # [è®Šæ•¸] Artifact Registry å­˜å„²åº«åç¨±
  REGION: asia-east1                                 # [è®Šæ•¸] GCP çš„åœ°ç†å€åŸŸä½ç½®

jobs:                                                # [ä»»å‹™å€å¡Š] å®£å‘Šæµæ°´ç·šåŒ…å«çš„æ‰€æœ‰ç¨ç«‹ä»»å‹™
  # ================================================================================================= # [å€éš”ç·š] Job 1 é–‹å§‹
  # Job 1: åŸºç¤è¨­æ–½èˆ‡åŸºæº–ç·šéƒ¨ç½² (Setup Infrastructure & Baseline v1)                                     # [å‚™è¨»] è² è²¬ç’°å¢ƒåˆå§‹åŒ–èˆ‡ v1 éƒ¨ç½²
  # ================================================================================================= # [å€éš”ç·š]
  setup-infrastructure:                              # [ä»»å‹™ ID] åŸºç¤è¨­æ–½æº–å‚™éšæ®µ
    name: Setup Infra & Baseline v1                  # [ä»»å‹™åç¨±] é¡¯ç¤ºåœ¨æµç¨‹åœ–ä¸­çš„æ¨™é¡Œ
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨] ä½¿ç”¨ GitHub æä¾›çš„æœ€æ–° Ubuntu è™›æ“¬æ©Ÿ
    steps:                                           # [æ­¥é©Ÿæ¸…å–®] ä»»å‹™å…§çš„å…·é«”æ“ä½œæ­¥é©Ÿ
      - name: Checkout Code                          # [æ­¥é©Ÿæ¨™é¡Œ] ç²å–åŸå§‹ç¢¼
        uses: actions/checkout@v3                    # [å¼•ç”¨] ä¸‹è¼‰ç•¶å‰å€‰åº«ä»£ç¢¼

      - name: Authenticate to GCP                    # [æ­¥é©Ÿæ¨™é¡Œ] ç™»å…¥ Google Cloud
        uses: google-github-actions/auth@v1          # [å¼•ç”¨] ä½¿ç”¨ GCP å®˜æ–¹èªè­‰å·¥å…·
        with:                                        # [åƒæ•¸å‚³å…¥]
          credentials_json: ${{ secrets.GCP_SA_KEY }} # [é‡‘é‘°] å¼•ç”¨åŠ å¯†çš„ GCP æœå‹™å¸³è™Ÿé‡‘é‘°

      - name: Setup Terraform                        # [æ­¥é©Ÿæ¨™é¡Œ] å®‰è£ Terraform
        uses: hashicorp/setup-terraform@v2           # [å¼•ç”¨] å®‰è£ HashiCorp å®˜æ–¹å·¥å…·
        with:                                        # [åƒæ•¸å‚³å…¥]
          terraform_version: 1.5.7                   # [ç‰ˆæœ¬] é–å®š IaC å·¥å…·ç‰ˆæœ¬

      - name: Terraform Apply                        # [æ­¥é©Ÿæ¨™é¡Œ] å»ºç«‹é›²ç«¯è³‡æº
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          cd terraform                               # [æŒ‡ä»¤] é€²å…¥ Terraform è³‡æ–™å¤¾
          terraform init                             # [æŒ‡ä»¤] åˆå§‹åŒ– Provider èˆ‡ Backend
          terraform apply -auto-approve              # [æŒ‡ä»¤] è‡ªå‹•åŸ·è¡Œéƒ¨ç½²è€Œä¸éœ€äººå·¥ç¢ºèª
        env:                                         # [ç’°å¢ƒè®Šæ•¸] æ³¨å…¥éƒ¨ç½²æ¬Šé™
          GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }} # [åƒæ•¸] è³¦äºˆ Terraform éƒ¨ç½²è³‡æºæ¬Šé™

      - name: Get GKE Credentials                    # [æ­¥é©Ÿæ¨™é¡Œ] ç²å– GKE æ§åˆ¶æ¬Š
        uses: google-github-actions/get-gke-credentials@v1 # [å¼•ç”¨] å®˜æ–¹å·¥å…·
        with:                                        # [åƒæ•¸å‚³å…¥]
          cluster_name: ${{ env.GKE_CLUSTER }}       # [åƒæ•¸] ç›®æ¨™å¢é›†åç¨±
          location: ${{ env.GKE_ZONE }}              # [åƒæ•¸] ç›®æ¨™å€åŸŸ

      - name: Run Ansible Playbook                   # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œ Ansible é…ç½®
        working-directory: ./ansible                 # [ç›®éŒ„] åœ¨ ansible è³‡æ–™å¤¾å…§åŸ·è¡Œ
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          pip install ansible kubernetes             # [æŒ‡ä»¤] å®‰è£è‡ªå‹•åŒ–é‹ç¶­å¥—ä»¶
          ansible-galaxy install -r requirements.yml # [æŒ‡ä»¤] ä¸‹è¼‰ Ansible K8s æ¨¡çµ„
          ansible-playbook k8s_init.yml \
            -e "telegram_token=${{ secrets.TG_TOKEN }}" \
            -e "telegram_chat_id=${{ secrets.TG_CHAT_ID }}" # [æŒ‡ä»¤] åŸ·è¡ŒåŠ‡æœ¬ä¸¦æ³¨å…¥ Telegram åƒæ•¸
        env:                                         # [ç’°å¢ƒè®Šæ•¸] 
          ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3 # [æŒ‡ä»¤] å¼·åˆ¶ä½¿ç”¨ Python3

      - name: Configure Docker                       # [æ­¥é©Ÿæ¨™é¡Œ] èªè­‰ Docker Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev # [æŒ‡ä»¤] æˆæ¬Š Docker è¨ªå• GCP å€‰åº«

      - name: Build and Push v1                      # [æ­¥é©Ÿæ¨™é¡Œ] å»ºæ§‹ä¸¦æ¨é€ v1 æ˜ åƒæª”
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          FULL_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}" # [è·¯å¾‘] å®šç¾©å®Œæ•´è·¯å¾‘
          docker build -t ${FULL_PATH}:v1 .          # [æŒ‡ä»¤] æ‰“åŒ… v1 æ˜ åƒæª”
          docker push ${FULL_PATH}:v1                 # [æŒ‡ä»¤] æ¨é€æ˜ åƒæª”è‡³å€‰åº«

      - name: Deploy Baseline (v1 & Monitoring)      # [æ­¥é©Ÿæ¨™é¡Œ] éƒ¨ç½²åŸºæº–ç·šç’°å¢ƒ
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          kubectl apply -f k8s/redis.yaml            # [æŒ‡ä»¤] å•Ÿå‹• Redis è³‡æ–™åº«
          kubectl apply -f k8s/monitoring/prometheus.yaml # [æŒ‡ä»¤] å•Ÿå‹• Prometheus ç›£æ§
          kubectl apply -f k8s/monitoring/grafana.yaml    # [æŒ‡ä»¤] å•Ÿå‹• Grafana å„€è¡¨æ¿
          kubectl apply -f k8s/app-blue.yaml         # [æŒ‡ä»¤] å•Ÿå‹• Flask App v1
          kubectl apply -f k8s/service.yaml          # [æŒ‡ä»¤] å•Ÿå‹• LoadBalancer æœå‹™

      - name: Notify Telegram (Wait for IP & v1 Ready) # [æ­¥é©Ÿæ¨™é¡Œ] IP è¼ªè©¢èˆ‡ Telegram é€šçŸ¥
        if: success()                                # [åˆ¤æ–·] åƒ…åœ¨å‰é¢æˆåŠŸæ™‚åŸ·è¡Œ
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}          # [åƒæ•¸] Telegram Token
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}      # [åƒæ•¸] Telegram ID
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          echo "ç­‰å¾… GCP åˆ†é… IP (æœ€é•· 3 åˆ†é˜)..."     # [å‚™è¨»] é¡¯ç¤ºç‹€æ…‹
          for i in {1..18}; do                       # [å¾ªç’°] åŸ·è¡Œ 18 æ¬¡è¼ªè©¢
            APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "") # [æŒ‡ä»¤] æŠ“å– IP
            GRAFANA_IP=$(kubectl get svc grafana-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "") # [æŒ‡ä»¤] æŠ“å– IP
            if [ ! -z "$APP_IP" ] && [ ! -z "$GRAFANA_IP" ]; then break; fi # [åˆ¤æ–·] è‹¥ IP å‡ºç¾å‰‡è·³å‡º
            sleep 10                                 # [æŒ‡ä»¤] ç­‰å¾… 10 ç§’
          done                                       # [çµæŸå¾ªç’°]
          F_APP_IP=${APP_IP:-"Pending"}              # [è™•ç†] è‹¥ç„¡ IP å‰‡é¡¯ç¤º Pending
          F_GRAFANA_IP=${GRAFANA_IP:-"Pending"}      # [è™•ç†] è‹¥ç„¡ IP å‰‡é¡¯ç¤º Pending
          MSG="âœ… [Baseline Ready] v1 å·²å°±ç·’ï¼%0AğŸŒ ç¶²ç«™(v1): http://${F_APP_IP}%0AğŸ“Š Grafana: http://${F_GRAFANA_IP}" # [å®šç¾©] è¨Šæ¯å…§å®¹
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG" # [æŒ‡ä»¤] ç™¼é€é€šçŸ¥

  # ================================================================================================= # [å€éš”ç·š] Job 2 é–‹å§‹
  # Job 2: é‡‘çµ²é›€éƒ¨ç½² (Deploy Canary)                                                                     # [å‚™è¨»] è² è²¬ v2 é‡‘çµ²é›€éƒ¨ç½²
  # ================================================================================================= # [å€éš”ç·š]
  deploy-canary:                                     # [ä»»å‹™ ID]
    name: Build & Release Canary                     # [ä»»å‹™åç¨±]
    needs: setup-infrastructure                      # [ä¾è³´] å¿…é ˆç­‰ Job 1 æˆåŠŸæ‰å•Ÿå‹•
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨] Ubuntu
    environment: canary-release                      # [é–˜é–€] é–‹å•Ÿäººå·¥å¯©æ ¸æ©Ÿåˆ¶
    steps:                                           # [æ­¥é©Ÿæ¸…å–®]
      - name: Checkout Code                          # [æ­¥é©Ÿ] ä¸‹è¼‰ä»£ç¢¼
        uses: actions/checkout@v3

      - name: Authenticate to GCP                    # [æ­¥é©Ÿ] GCP èªè­‰
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker                       # [æ­¥é©Ÿ] æˆæ¬Š Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Generate SHA Tag                       # [æ­¥é©Ÿæ¨™é¡Œ] ç”Ÿæˆç‰ˆæœ¬æ¨™ç±¤
        id: get_tag                                  # [ID] è­˜åˆ¥ç¢¼
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT # [æŒ‡ä»¤] æå– Git Hash

      - name: Build and Push v2                      # [æ­¥é©Ÿæ¨™é¡Œ] å»ºæ§‹ v2 æ˜ åƒæª”
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          SHA: ${{ steps.get_tag.outputs.sha_short }} # [è®Šæ•¸] è®€å– Hash
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          FULL_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}" # [å®šç¾©]
          docker build -t ${FULL_PATH}:${SHA} -t ${FULL_PATH}:v2 . # [æŒ‡ä»¤] æ‰“åŒ… v2
          docker push ${FULL_PATH}:${SHA}             # [æŒ‡ä»¤] æ¨é€ SHA ç‰ˆæœ¬
          docker push ${FULL_IMAGE_PATH}:v2          # [æŒ‡ä»¤] æ¨é€ v2 ç‰ˆæœ¬

      - name: Get GKE Credentials                    # [æ­¥é©Ÿ] ç²å–æ†‘è­‰
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Deploy Canary Only                     # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œé‡‘çµ²é›€ç™¼ä½ˆ
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          kubectl apply -f k8s/canary-deployment.yaml # [æŒ‡ä»¤] éƒ¨ç½² v2 Pod
          kubectl rollout restart deployment pca-app-canary -n pca-app-ns # [æŒ‡ä»¤] é‡å•Ÿ Pod ä»¥æ›´æ–°æ˜ åƒæª”

      - name: Notify Telegram (Canary Released)       # [æ­¥é©Ÿæ¨™é¡Œ] é‡‘çµ²é›€ä¸Šç·šé€šçŸ¥
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}') # [æŒ‡ä»¤]
          MSG="ğŸ¤ [Canary Live] v2 å·²ä¸Šç·šï¼%0AğŸŒ æ¸¬è©¦ç¶²å€: http://${APP_IP}" # [å…§å®¹]
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG" # [æŒ‡ä»¤]

  # ================================================================================================= # [å€éš”ç·š] Job 3 é–‹å§‹
  # Job 3: å…¨é¢åˆ‡æ› (Full Rollout)                                                                        # [å‚™è¨»] æµé‡ 100% åˆ‡æ›è‡³ v2
  # ================================================================================================= # [å€éš”ç·š]
  full-rollout:                                      # [ä»»å‹™ ID]
    name: Approval & Full Rollout                    # [ä»»å‹™åç¨±]
    needs: deploy-canary                             # [ä¾è³´] ç­‰é‡‘çµ²é›€å®Œæˆ
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨] Ubuntu
    environment: production                          # [é–˜é–€] é–‹å•Ÿç¬¬äºŒæ¬¡äººå·¥æ ¸å‡†
    steps:                                           # [æ­¥é©Ÿæ¸…å–®]
      - name: Checkout Code                          # [æ­¥é©Ÿ] ä¸‹è¼‰ä»£ç¢¼
        uses: actions/checkout@v3

      - name: Authenticate to GCP                    # [æ­¥é©Ÿ] GCP èªè­‰
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE Credentials                    # [æ­¥é©Ÿ] ç²å–æ†‘è­‰
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Full Rollout (v2)                      # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œå…¨é¢åˆ‡æ›
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          kubectl apply -f k8s/app-green.yaml        # [æŒ‡ä»¤] éƒ¨ç½² v2 æ­£å¼ç‰ˆ Pod
          kubectl patch svc pca-app-service -n pca-app-ns -p "{\"spec\":{\"selector\":{\"version\":\"v2\"}}}" # [æŒ‡ä»¤] ä¿®æ”¹ Selector åˆ‡æ›æµé‡
          kubectl delete -f k8s/canary-deployment.yaml --ignore-not-found=true # [æŒ‡ä»¤] æ¸…ç†æ¸¬è©¦ç‰ˆè³‡æº

      - name: Notify Telegram (Success)               # [æ­¥é©Ÿæ¨™é¡Œ] æœ€çµ‚æˆåŠŸé€šçŸ¥
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [è…³æœ¬åŸ·è¡Œ]
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}') # [æŒ‡ä»¤]
          MSG="ğŸš€ [Full Rollout] 100% åˆ‡æ›è‡³ v2 å®Œæˆï¼" # [å…§å®¹]
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG" # [æŒ‡ä»¤]