# =====================================================================================================
# æª”æ¡ˆåç¨±ï¼š.github/workflows/deploy.yml
# å°ˆæ¡ˆåç¨±ï¼šPCA DevOps Exam - SRE Observability & Alerting
# æ ¸å¿ƒåƒ¹å€¼ï¼šè½å¯¦ Infrastructure as Code (IaC) èˆ‡è‡ªå‹•åŒ–éƒ¨ç½²ï¼Œçµåˆå³æ™‚å‘Šè­¦ç›£æŽ§ã€‚
# =====================================================================================================

name: PCA DevOps Exam Pipeline (Final Alerting)     # [å·¥ä½œæµåç¨±] å®šç¾©æ­¤ CI/CD åœ¨ GitHub ç®¡ç†ä»‹é¢çš„é¡¯ç¤ºæŠ¬é ­

on:                                                  # [è§¸ç™¼] ç›£è½äº‹ä»¶çš„å•Ÿå‹•é»ž
  push:                                              # [æŽ¨é€äº‹ä»¶] ç•¶æœ‰ç¨‹å¼ç¢¼æŽ¨é€åˆ° GitHub æ™‚
    branches: [ "main" ]                             # [åˆ†æ”¯éŽæ¿¾] åƒ…é™ main åˆ†æ”¯çš„æŽ¨é€
  workflow_dispatch:                                  # [æ‰‹å‹•è§¸ç™¼] åœ¨ GitHub Web UI æä¾›æŒ‰éˆ•

env:                                                 # [ç’°å¢ƒå€å¡Š] å®£å‘Šè·¨ Job ä½¿ç”¨çš„è®Šæ•¸
  PROJECT_ID: danny-pca-lab                          # [GCP] å°ˆæ¡ˆå”¯ä¸€æ¨™è­˜ç¬¦
  GKE_CLUSTER: pca-cluster                           # [GKE] ç›®æ¨™ Kubernetes å¢é›†åç¨±
  GKE_ZONE: asia-east1-a                             # [GKE] å¢é›†æ‰€åœ¨çš„å€åŸŸ
  IMAGE_NAME: flask-app                              # [Docker] æ˜ åƒæª”åŸºç¤Žåç¨±
  REPO_NAME: pca-repo                                # [Registry] Artifact Registry çš„å­˜å„²åº«åç¨±
  REGION: asia-east1                                 # [GCP] åœ°ç†å€åŸŸ

jobs:                                                # [ä»»å‹™å€å¡Š]
  # =================================================================================================
  # Job 1: åŸºç¤Žè¨­æ–½èˆ‡åŸºæº–ç·šæº–å‚™ (Setup Infrastructure & Baseline v1)
  # [SRE è€ƒé»ž]ï¼šå…ˆæœ‰ç›£æŽ§èˆ‡ç©©å®šç‰ˆï¼Œå†é€²è¡Œè®Šæ›´ã€‚
  # =================================================================================================
  setup-infrastructure:
    name: Setup Infra & Baseline v1
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code                          # [æ­¥é©Ÿ] ç²å–åŽŸå§‹ç¢¼
        uses: actions/checkout@v3

      - name: Authenticate to GCP                    # [æ­¥é©Ÿ] ç™»å…¥ Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform                        # [æ­¥é©Ÿ] é…ç½® Terraform ç’°å¢ƒ
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform Apply                        # [æ­¥é©Ÿ] å»ºç«‹é›²ç«¯åŸºç¤Žè¨­æ–½ (VPC/GKE/Repo)
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve 
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE Credentials                    # [æ­¥é©Ÿ] ç²å–å¢é›†æ“ä½œæ¬Šé™
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}

      - name: Run Ansible Playbook                   # [æ­¥é©Ÿ] åŸ·è¡Œ K8s å‘½åç©ºé–“èˆ‡å‘Šè­¦é…ç½®
        working-directory: ./ansible
        run: |
          pip install ansible kubernetes
          ansible-galaxy install -r requirements.yml 
          ansible-playbook k8s_init.yml \
            -e "telegram_token=${{ secrets.TG_TOKEN }}" \
            -e "telegram_chat_id=${{ secrets.TG_CHAT_ID }}"
        env:
          ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3

      - name: Deploy Baseline (v1 & Monitoring)      # [æ­¥é©Ÿæ¨™é¡Œ] éƒ¨ç½²åŸºæº–ç·šç’°å¢ƒ (v1/Redis/ç›£æŽ§)
        run: |                                       # [ run ]
          # 1. éƒ¨ç½²è³‡æ–™åº«èˆ‡ç›£æŽ§ç³»çµ± (SRE æ ¸å¿ƒä¾è³´)
          kubectl apply -f k8s/redis.yaml
          kubectl apply -f k8s/monitoring/prometheus.yaml
          kubectl apply -f k8s/monitoring/grafana.yaml
          
          # 2. éƒ¨ç½²ç©©å®šç‰ˆ v1 (Blue) ç¢ºä¿å¯©æ ¸å‰å·²æœ‰å¯é‹ä½œç³»çµ±
          kubectl apply -f k8s/app-blue.yaml
          
          # 3. éƒ¨ç½² Service å…¥å£ä¸¦å‘ GCP ç”³è«‹ LoadBalancer IP
          kubectl apply -f k8s/service.yaml

      - name: Notify Telegram (Wait for IP & v1 Ready) # [æ­¥é©Ÿæ¨™é¡Œ] åŸ·è¡Œ IP è¼ªè©¢èˆ‡å°±ç·’é€šçŸ¥
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |                                       # [ run ] å°ˆæ¥­ IP è¼ªè©¢é‚è¼¯
          echo "ç­‰å¾… GCP LoadBalancer åˆ†é…å¤–éƒ¨ IP (æœ€é•·ç­‰å¾… 3 åˆ†é˜)..."
          for i in {1..18}; do
            # é€éŽ JSONPath æŠ“å– IP ä½å€
            APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            GRAFANA_IP=$(kubectl get svc grafana-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            
            # åˆ¤æ–·æ˜¯å¦å…©è€…çš†å·²ç²å– IP
            if [ ! -z "$APP_IP" ] && [ ! -z "$GRAFANA_IP" ]; then
              echo "âœ… IP è³‡æºç²å–æˆåŠŸï¼"
              break
            fi
            echo "âŒ› IP å°šæœªå°±ç·’ï¼Œç­‰å¾… 10 ç§’... ($i/18)"
            sleep 10
          done

          # è®Šæ•¸é˜²è­·ï¼šè‹¥è¶…æ™‚å‰‡æ¨™è¨» Pending
          FINAL_APP_IP=${APP_IP:-"Pending(è«‹ç¨å¾Œåˆ·æ–°)"}
          FINAL_GRAFANA_IP=${GRAFANA_IP:-"Pending(è«‹ç¨å¾Œåˆ·æ–°)"}

          MSG="âœ… [Baseline Ready] v1 åŸºæº–ç·šå·²å°±ç·’ï¼%0AðŸŒ ç¶²ç«™(v1): http://${FINAL_APP_IP}%0AðŸ“Š Grafana: http://${FINAL_GRAFANA_IP}%0Aç¢ºèª v1 ç©©å®šå¾Œè«‹é€²è¡Œ Job 2 é‡‘çµ²é›€æ ¸å‡†ã€‚"
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG"

      - name: Notify Telegram (Job 1 Failed)         # [æ­¥é©Ÿ] æ•…éšœå‘Šè­¦
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
          -d chat_id="${TG_CHAT_ID}" \
          -d text="âŒ [Alert] Job 1 (åŸºç¤Žè¨­æ–½/v1) éƒ¨ç½²å¤±æ•—ï¼"

  # =================================================================================================
  # Job 2: é‡‘çµ²é›€éƒ¨ç½² (Deploy Canary) - éœ€äººå·¥æ ¸å‡†
  # =================================================================================================
  deploy-canary:
    name: Build & Release Canary
    needs: setup-infrastructure
    runs-on: ubuntu-latest
    environment: canary-release                      # [é–˜é–€] äººå·¥æ ¸å‡†é»ž
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Generate SHA Tag
        id: get_tag
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and Push
        env:
          SHA: ${{ steps.get_tag.outputs.sha_short }}
        run: |
          FULL_IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}"
          docker build -t ${FULL_IMAGE_PATH}:${SHA} -t ${FULL_IMAGE_PATH}:v2 .
          docker push ${FULL_IMAGE_PATH}:${SHA}
          docker push ${FULL_IMAGE_PATH}: