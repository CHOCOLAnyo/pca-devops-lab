#k8s/canary-deployment.yaml
# -------------------------------------------------------------------------------------
# è³‡æºåç¨±ï¼šé‡‘çµ²é›€éƒ¨ç½²å¯¦é«” (Canary Deployment) - ç›£æ§å¼·åŒ–ç‰ˆ
# æ ¸å¿ƒåŠŸèƒ½ï¼šéƒ¨ç½² v2 å…ˆé£éƒ¨éšŠï¼Œä¸¦é€é Annotations ä¸»å‹•å‘ŠçŸ¥ Prometheus é€²è¡Œæ•¸æ“šæŠ“å–ã€‚
# -------------------------------------------------------------------------------------
apiVersion: apps/v1             # [ç‰ˆæœ¬] Deployment æ¨™æº– API ç‰ˆæœ¬
kind: Deployment                # [ç¨®é¡] å®šç¾©ç‚ºéƒ¨ç½²è³‡æºï¼Œç®¡ç† Pod çš„ç”Ÿå‘½é€±æœŸ
metadata:                       # [å…ƒæ•¸æ“š] è³‡æºåŸºæœ¬è³‡è¨Š
  name: pca-app-canary          # [åç¨±] èº«åˆ†è­‰å­—è™Ÿï¼Œå¿…é ˆèˆ‡æµæ°´ç·šé‡å•ŸæŒ‡ä»¤å°é½Š
  namespace: pca-app-ns         # [ç©ºé–“] ç¢ºä¿èˆ‡ç›£æ§ç³»çµ±ã€Redis è™•æ–¼ç›¸åŒå‘½åç©ºé–“
spec:                           # [è¦æ ¼]
  # -----------------------------------------------------------------------------------
  # å‰¯æœ¬æ•¸èˆ‡æµé‡æ¯”ä¾‹ (Traffic Ratio)
  # -----------------------------------------------------------------------------------
  replicas: 1                   # [æ•¸é‡] åƒ…éœ€ 1 éš» Pod (èˆ‡ v1 å½¢æˆ 25% çš„æµé‡ä½”æ¯”)
  
  selector:                     # [é¸æ“‡å™¨] å®šç¾© Deployment ç›£ç®¡å“ªäº›æ¨™ç±¤çš„ Pod
    matchLabels:
      app: pca-app              # é—œè¯æ¨™ç±¤ï¼šapp å¿…é ˆç‚º pca-app
      version: v2               # ç‰ˆæœ¬é–å®šï¼šåƒ…ç®¡ç† v2 ç‰ˆæœ¬
      
  template:                     # [æ¨¡æ¿] å®šç¾© Pod çš„å…·é«”é…ç½®
    metadata:                   # [Pod å…ƒæ•¸æ“š]
      # -------------------------------------------------------------------------------
      # ğŸ”¥ [SRE é—œéµé…ç½®] Prometheus æŠ“å–è¨»è§£
      # ç›®çš„ï¼šè®“ Prometheus è‡ªå‹•ç™¼ç¾æ­¤ Pod ä¸¦é–‹å§‹æ¡é›† /metrics æŒ‡æ¨™
      # -------------------------------------------------------------------------------
      annotations:
        prometheus.io/scrape: "true"    # [æŒ‡ä»¤] å‘ŠçŸ¥ Prometheusï¼šé€™éš» Pod æœ‰æŒ‡æ¨™å¯ä»¥æŠ“
        prometheus.io/path: "/metrics"  # [è·¯å¾‘] æŒ‡æ¨™æ•¸æ“šå­˜æ”¾çš„ç¶²å€è·¯å¾‘ (Flask é è¨­è·¯å¾‘)
        prometheus.io/port: "5000"      # [ç«¯å£] ç¨‹å¼å…§éƒ¨ç›£è½çš„åŸ è™Ÿï¼ŒPrometheus æœƒå¾€é€™ç™¼è«‹æ±‚
      
      labels:                   # [æ ¸å¿ƒæ¨™ç±¤]
        app: pca-app            # [æµé‡æ¨™ç±¤] è®“ Service ç¸½æ©Ÿèƒ½æŠŠ 25% æµé‡å°é€²ä¾†
        version: v2             # [æŒ‡æ¨™æ¨™ç±¤] è®“ Grafana èƒ½å€åˆ† v1 èˆ‡ v2 çš„æµé‡æ›²ç·š
        
    spec:                       # [å®¹å™¨è¦æ ¼]
      containers:
      - name: flask-app         # å®¹å™¨åç¨±
        # [æ˜ åƒæª”è·¯å¾‘] æŒ‡å‘ Artifact Registry ä¸­çš„ v2 æ˜ åƒæª”
        image: asia-east1-docker.pkg.dev/danny-pca-lab/pca-repo/flask-app:v2 
        
        # å¼·åˆ¶æ‹‰å–ç­–ç•¥
        # åŸå› ï¼šå¦‚æœä¸åŠ é€™è¡Œï¼ŒK8s ç™¼ç¾æœ¬åœ°æœ‰ v2 å°±æœƒç›´æ¥ç”¨èˆŠçš„ï¼Œå°è‡´ä½ çš„ç¨‹å¼ç¢¼æ›´æ–°ç„¡æ•ˆ
        imagePullPolicy: Always
        
        ports:                  # [ç«¯å£è¨­å®š]
        - containerPort: 5000   # å®¹å™¨å…§éƒ¨é–‹æ”¾çš„åŸ è™Ÿ
        
        env:                    # [ç’°å¢ƒè®Šæ•¸] åŸ·è¡Œæ™‚æœŸæ³¨å…¥
        - name: APP_VERSION     # æ¨™è¨»ç‰ˆæœ¬ï¼Œè®“ç¶²ç«™é¡¯ç¤º (v2)
          value: "v2"
          
        - name: REDIS_HOST      # Redis é€£ç·šåœ°å€
          value: "redis-service"

        # æ©Ÿæ•è³‡è¨Š (Secrets)
        # åŸå› ï¼šæ²’æœ‰é€™æ®µï¼Œé‡‘çµ²é›€ç‰ˆæœ¬çš„æŠ•ç¥¨åŠŸèƒ½æœƒå£æ‰ (ç„¡æ³•é€£ç·š Telegram)
        - name: TELEGRAM_TOKEN
          valueFrom:
            secretKeyRef:
              name: telegram-secret
              key: TELEGRAM_TOKEN
        - name: TELEGRAM_CHAT_ID
          valueFrom:
            secretKeyRef:
              name: telegram-secret
              key: TELEGRAM_CHAT_ID