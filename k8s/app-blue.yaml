# ===================================================================================================== # [è¨»è§£] æª”æ¡ˆèµ·å§‹å€éš”ç·š
# æª”æ¡ˆåç¨±ï¼š.github/workflows/deploy.yml                                                                # [è¨»è§£] æ¨™è¨»æ­¤ YAML æª”æ¡ˆåœ¨å°ˆæ¡ˆä¸­çš„å¯¦é«”è·¯å¾‘
# å°ˆæ¡ˆåç¨±ï¼šPCA DevOps Exam - SRE Observability & Alerting                                              # [è¨»è§£] æ¨™è¨»å°ˆæ¡ˆçš„ä¸»é¡Œåç¨±
# æ ¸å¿ƒåƒ¹å€¼ï¼šè½å¯¦ CI/CD æµç¨‹ä¸­ã€Œå…ˆå»ºæ§‹ã€å¾Œéƒ¨ç½²ã€çš„åŸå­æ€§åŸå‰‡ï¼Œä¸¦ç¢ºä¿ç›£æ§åŸºæº–ç·š (Baseline) é å…ˆå°±ç·’ã€‚         # [è¨»è§£] èªªæ˜æ­¤æµæ°´ç·šçš„è¨­è¨ˆå“²å­¸
# ===================================================================================================== # [è¨»è§£] æª”æ¡ˆèµ·å§‹å€éš”çµæŸ

name: PCA DevOps Exam Pipeline (Final Alerting)     # [è¨»è§£] å®šç¾© GitHub Actions å·¥ä½œæµåœ¨ç¶²é ä»‹é¢ä¸Šé¡¯ç¤ºçš„æ¨™é¡Œåç¨±

on:                                                  # [è¨»è§£] å®šç¾©è§¸ç™¼è‡ªå‹•åŒ–æµç¨‹çš„äº‹ä»¶ä¾†æº
  push:                                              # [è¨»è§£] ç›£è½ä»£ç¢¼æ¨é€äº‹ä»¶
    branches: [ "main" ]                             # [è¨»è§£] åƒ…é™æ–¼æ¨é€åˆ° main åˆ†æ”¯æ™‚æ‰å•Ÿå‹•æµç¨‹ï¼Œä¿è­·æ­£å¼ç’°å¢ƒ
  workflow_dispatch:                                  # [è¨»è§£] å…è¨±ä½¿ç”¨è€…åœ¨ GitHub ç¶²é  UI ä¸Šæ‰‹å‹•é»æ“ŠæŒ‰éˆ•ä¾†å•Ÿå‹•å·¥ä½œæµ

env:                                                 # [è¨»è§£] å…¨åŸŸç’°å¢ƒè®Šæ•¸å€å¡Šï¼Œæ‰€æœ‰ Job éƒ½èƒ½å…±ç”¨é€™äº›åƒæ•¸
  PROJECT_ID: danny-pca-lab                          # [è¨»è§£] å¡«å…¥ä½ çš„ GCP å°ˆæ¡ˆå”¯ä¸€ ID
  GKE_CLUSTER: pca-cluster                           # [è¨»è§£] å®šç¾©ç›®æ¨™ GKE å¢é›†çš„åç¨±
  GKE_ZONE: asia-east1-a                             # [è¨»è§£] å®šç¾© GKE å¢é›†æ‰€åœ¨çš„å€åŸŸè³‡æ–™ä¸­å¿ƒä½ç½®
  IMAGE_NAME: flask-app                              # [è¨»è§£] å®šç¾© Docker æ˜ åƒæª”çš„åç¨±
  REPO_NAME: pca-repo                                # [è¨»è§£] å®šç¾© Artifact Registry å­˜å„²åº«çš„åç¨±
  REGION: asia-east1                                 # [è¨»è§£] å®šç¾© GCP çš„ä¸»è¦åœ°ç†å€åŸŸ

jobs:                                                # [è¨»è§£] ä»»å‹™åŸ·è¡Œå€å¡Šï¼Œå®šç¾©æµæ°´ç·šåŒ…å«çš„å„å€‹ç¨ç«‹å·¥ä½œå–®å…ƒ
  # ================================================================================================= # [è¨»è§£] Job 1 å€éš”ç·š
  # Job 1: åŸºç¤è¨­æ–½æº–å‚™èˆ‡åŸºæº–ç·šéƒ¨ç½² (Setup Infrastructure & Baseline v1)                                     # [è¨»è§£] è² è²¬è³‡æºå»ºç«‹èˆ‡ç¬¬ä¸€å€‹ç©©å®šç‰ˆæœ¬çš„éƒ¨ç½²
  # ================================================================================================= # [è¨»è§£] Job 1 å€éš”ç·š
  setup-infrastructure:                              # [è¨»è§£] ä»»å‹™å”¯ä¸€è­˜åˆ¥ç¢¼
    name: Setup Infra & Baseline v1                  # [è¨»è§£] åœ¨ GitHub Actions æµç¨‹åœ–ä¸­é¡¯ç¤ºçš„ä»»å‹™åç¨±
    runs-on: ubuntu-latest                           # [è¨»è§£] ä½¿ç”¨ GitHub è¨—ç®¡çš„æœ€æ–° Ubuntu Linux ç’°å¢ƒä½œç‚ºåŸ·è¡Œæ©Ÿ
    steps:                                           # [è¨»è§£] æ­¤ä»»å‹™å…§å…·é«”çš„æ“ä½œæ­¥é©Ÿæ¸…å–®
      - name: Checkout Code                          # [è¨»è§£] æ­¥é©Ÿæ¨™é¡Œï¼šç²å–ä»£ç¢¼
        uses: actions/checkout@v3                    # [è¨»è§£] å¼•ç”¨å®˜æ–¹å·¥å…·ï¼Œå°‡ç•¶å‰ GitHub å€‰åº«çš„ä»£ç¢¼ä¸‹è¼‰åˆ°åŸ·è¡Œæ©Ÿç’°å¢ƒ

      - name: Authenticate to GCP                    # [è¨»è§£] æ­¥é©Ÿæ¨™é¡Œï¼šç™»å…¥ Google Cloud
        uses: google-github-actions/auth@v1          # [è¨»è§£] å¼•ç”¨ GCP èªè­‰å·¥å…·
        with:                                        # [è¨»è§£] å‚³å…¥å·¥å…·æ‰€éœ€çš„åƒæ•¸
          credentials_json: ${{ secrets.GCP_SA_KEY }} # [è¨»è§£] å¾ GitHub Secrets è®€å–åŠ å¯†çš„ Service Account é‡‘é‘°

      - name: Setup Terraform                        # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šé…ç½® Terraform
        uses: hashicorp/setup-terraform@v2           # [è¨»è§£] å®‰è£ä¸¦åˆå§‹åŒ– Terraform åŸ·è¡Œç’°å¢ƒå·¥å…·
        with:                                        # [è¨»è§£] å‚³å…¥åƒæ•¸
          terraform_version: 1.5.7                   # [è¨»è§£] é–å®šç‰ˆæœ¬ï¼Œç¢ºä¿ IaC ç’°å¢ƒåœ¨å„æ¬¡åŸ·è¡Œä¸­ä¿æŒä¸€è‡´æ€§

      - name: Terraform Apply                        # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šåŸ·è¡Œé›²ç«¯è³‡æºå»ºç«‹
        run: |                                       # [è¨»è§£] åŸ·è¡Œå¤šè¡Œ Shell æŒ‡ä»¤è…³æœ¬
          cd terraform                               # [è¨»è§£] æŒ‡ä»¤ï¼šåˆ‡æ›è‡³å­˜æ”¾ Terraform è…³æœ¬çš„è³‡æ–™å¤¾
          terraform init                             # [è¨»è§£] æŒ‡ä»¤ï¼šåˆå§‹åŒ–å¾Œç«¯å­˜å„²èˆ‡å¤–æ›æ’ä»¶
          terraform apply -auto-approve              # [è¨»è§£] æŒ‡ä»¤ï¼šåŸ·è¡Œéƒ¨ç½²ä¸¦å¼·åˆ¶æ‰¹å‡†è®Šæ›´ï¼Œå¯¦ç¾ç„¡äººå€¼å®ˆè‡ªå‹•åŒ–
        env:                                         # [è¨»è§£] å±€éƒ¨ç’°å¢ƒè®Šæ•¸
          GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }} # [è¨»è§£] æä¾›é‡‘é‘°ï¼Œè®“ Terraform å…·å‚™åœ¨ GCP å»ºç«‹è³‡æºçš„æ¬Šé™

      - name: Get GKE Credentials                    # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šç²å– GKE æ§åˆ¶æ¬Š
        uses: google-github-actions/get-gke-credentials@v1 # [è¨»è§£] å¼•ç”¨å®˜æ–¹å·¥å…·ï¼Œç²å– GKE æ†‘è­‰
        with:                                        # [è¨»è§£] å‚³å…¥åƒæ•¸
          cluster_name: ${{ env.GKE_CLUSTER }}       # [è¨»è§£] å¼•ç”¨å…¨åŸŸè®Šæ•¸ä¸­çš„å¢é›†åç¨±
          location: ${{ env.GKE_ZONE }}              # [è¨»è§£] å¼•ç”¨å…¨åŸŸè®Šæ•¸ä¸­çš„å¢é›†å€åŸŸ

      - name: Run Ansible Playbook                   # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šåŸ·è¡Œé…ç½®ç®¡ç†
        working-directory: ./ansible                 # [è¨»è§£] æŒ‡å®šæ­¤æ­¥é©Ÿçš„å·¥ä½œè·¯å¾‘ç‚º ansible è³‡æ–™å¤¾
        run: |                                       # [è¨»è§£] åŸ·è¡Œè…³æœ¬
          pip install ansible kubernetes             # [è¨»è§£] æŒ‡ä»¤ï¼šå®‰è£ Ansible éœ€è¦çš„ Python ç›¸ä¾å¥—ä»¶
          ansible-galaxy install -r requirements.yml # [è¨»è§£] æŒ‡ä»¤ï¼šä¸‹è¼‰ Playbook æ‰€éœ€çš„ K8s å¤–æ›æ¨¡çµ„
          ansible-playbook k8s_init.yml \
            -e "telegram_token=${{ secrets.TG_TOKEN }}" \
            -e "telegram_chat_id=${{ secrets.TG_CHAT_ID }}" # [è¨»è§£] æŒ‡ä»¤ï¼šåŸ·è¡ŒåŠ‡æœ¬ä¸¦æ³¨å…¥å‘Šè­¦åƒæ•¸
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3 # [è¨»è§£] æŒ‡ä»¤ï¼šæŒ‡å®š Python3 è·¯å¾‘ï¼Œé¿å…ç’°å¢ƒè¡çª

      # --- [é—œéµä¿®å¾©]ï¼šè§£æ±º ImagePullBackOff å•é¡Œï¼Œç¢ºä¿æ˜ åƒæª”å„ªå…ˆç”¢å‡º ---
      - name: Configure Docker                       # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šèªè­‰ Docker Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev # [è¨»è§£] æŒ‡ä»¤ï¼šè®“ Docker å…·å‚™æ¨é€æ¬Šé™

      - name: Build and Push v1                      # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šå»ºæ§‹ä¸¦æ¨é€ v1 ç©©å®šç‰ˆæ˜ åƒæª”
        run: |                                       # [è¨»è§£] åŸ·è¡ŒæŒ‡ä»¤
          FULL_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}" # [è¨»è§£] å®šç¾©è·¯å¾‘è®Šæ•¸
          docker build -t ${FULL_PATH}:v1 .          # [è¨»è§£] æŒ‡ä»¤ï¼šå»ºæ§‹æ˜ åƒæª”ä¸¦æ‰“ä¸Š v1 æ¨™ç±¤
          docker push ${FULL_PATH}:v1                 # [è¨»è§£] æŒ‡ä»¤ï¼šå°‡ v1 æ˜ åƒæª”æ¨é€åˆ° GCP å€‰åº«ï¼Œè§£æ±ºæ‹‰ä¸åˆ°åœ–çš„å•é¡Œ

      - name: Deploy Baseline (v1 & Monitoring)      # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šéƒ¨ç½²åŸºæº–ç·šç’°å¢ƒ
        run: |                                       # [è¨»è§£] åŸ·è¡ŒæŒ‡ä»¤
          kubectl apply -f k8s/redis.yaml            # [æŒ‡ä»¤]ï¼šéƒ¨ç½²è³‡æ–™åº«ç³»çµ±
          kubectl apply -f k8s/monitoring/prometheus.yaml # [æŒ‡ä»¤]ï¼šéƒ¨ç½²æŒ‡æ¨™ç›£æ§ç³»çµ±
          kubectl apply -f k8s/monitoring/grafana.yaml    # [æŒ‡ä»¤]ï¼šéƒ¨ç½²è¦–è¦ºåŒ–å„€è¡¨æ¿
          kubectl apply -f k8s/app-blue.yaml         # [æŒ‡ä»¤]ï¼šéƒ¨ç½²æ‡‰ç”¨ç¨‹å¼ç©©å®šç‰ˆ (Blue/v1)
          kubectl apply -f k8s/service.yaml          # [æŒ‡ä»¤]ï¼šéƒ¨ç½² Service å…¥å£ä¸¦å•Ÿå‹• LoadBalancer

      - name: Notify Telegram (Wait for IP & v1 Ready) # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šIP è¼ªè©¢èˆ‡å°±ç·’é€šçŸ¥
        if: success()                                # [åˆ¤æ–·]ï¼šåƒ…åœ¨ä¸Šè¿°æ‰€æœ‰æ­¥é©Ÿå‡æˆåŠŸæ™‚æ‰åŸ·è¡Œé€šçŸ¥
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}          # [åƒæ•¸]ï¼šTelegram Token
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}      # [åƒæ•¸]ï¼šTelegram ID
        run: |                                       # [è¨»è§£] åŸ·è¡Œè…³æœ¬
          echo "ç­‰å¾… GCP LoadBalancer åˆ†é…å¤–éƒ¨ IP (æœ€é•· 3 åˆ†é˜)..." # [æŒ‡ä»¤]ï¼šè¼¸å‡ºæç¤º
          for i in {1..18}; do                       # [è¿´åœˆ]ï¼šæ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œå…± 18 æ¬¡
            APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "") # [æŒ‡ä»¤]ï¼šæŸ¥è©¢æ‡‰ç”¨ IP
            GRAFANA_IP=$(kubectl get svc grafana-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "") # [æŒ‡ä»¤]ï¼šæŸ¥è©¢ç›£æ§ IP
            if [ ! -z "$APP_IP" ] && [ ! -z "$GRAFANA_IP" ]; then break; fi # [åˆ¤æ–·]ï¼šæ‹¿åˆ° IP å°±è·³å‡º
            sleep 10                                 # [æŒ‡ä»¤]ï¼šç­‰å¾…ä¸‹ä¸€æ¬¡æŸ¥è©¢
          done                                       # [çµæŸè¿´åœˆ]
          F_APP_IP=${APP_IP:-"Pending"}              # [æŒ‡ä»¤]ï¼šè‹¥æ²’æŠ“åˆ°å‰‡æ¨™è¨˜ç‚º Pending
          F_GRAFANA_IP=${GRAFANA_IP:-"Pending"}      # [æŒ‡ä»¤]ï¼šè‹¥æ²’æŠ“åˆ°å‰‡æ¨™è¨˜ç‚º Pending
          MSG="âœ… [Baseline Ready] v1 å·²å°±ç·’ï¼%0AğŸŒ ç¶²ç«™(v1): http://${F_APP_IP}%0AğŸ“Š Grafana: http://${F_GRAFANA_IP}" # [æŒ‡ä»¤]ï¼šçµ„åˆè¨Šæ¯å…§å®¹
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG" # [æŒ‡ä»¤]ï¼šå‚³é€ Telegram é€šå ±

  # ================================================================================================= # [è¨»è§£] Job 2 å€éš”ç·š
  # Job 2: é‡‘çµ²é›€éƒ¨ç½² (Deploy Canary) - éœ€è¦äººå·¥æ ¸å‡†å¾Œå•Ÿå‹•                                                  # [è¨»è§£] ç”¨æ–¼ç™¼å¸ƒæ–°ç‰ˆæœ¬é€²è¡Œå°‘é‡æ¸¬è©¦
  # ================================================================================================= # [è¨»è§£] Job 2 å€éš”ç·š
  deploy-canary:                                     # [ä»»å‹™ ID]
    name: Build & Release Canary                     # [ä»»å‹™åç¨±]
    needs: setup-infrastructure                      # [è¨»è§£] è¨­å®šä¾è³´ï¼šå¿…é ˆ Job 1 æˆåŠŸå¾Œæ­¤ä»»å‹™æ‰æœƒé€²å…¥å¾…å‘½ç‹€æ…‹
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨]
    environment: canary-release                      # [è¨»è§£] é–˜é–€ï¼šGitHub æœƒæš«åœåŸ·è¡Œï¼Œç›´åˆ°äººå·¥åœ¨ç¶²é é»æ“Š Approve
    steps:                                           # [æ­¥é©Ÿæ¸…å–®]
      - name: Checkout Code                          # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šä¸‹è¼‰ä»£ç¢¼
        uses: actions/checkout@v3                    # [å¼•ç”¨]

      - name: Authenticate to GCP                    # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šGCP ç™»å…¥
        uses: google-github-actions/auth@v1          # [å¼•ç”¨]
        with:                                        # [åƒæ•¸]
          credentials_json: ${{ secrets.GCP_SA_KEY }} # [åƒæ•¸]

      - name: Configure Docker                       # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šèªè­‰ Docker Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev # [æŒ‡ä»¤]

      - name: Generate SHA Tag                       # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šç”Ÿæˆç‰ˆæœ¬å”¯ä¸€æ¨™ç±¤
        id: get_tag                                  # [IDæ¨™è¨˜]
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT # [æŒ‡ä»¤]ï¼šæå– Git Commit çš„çŸ­å“ˆå¸Œç¢¼

      - name: Build and Push v2                      # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šå»ºæ§‹æ¸¬è©¦ç‰ˆ v2 æ˜ åƒæª”
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          SHA: ${{ steps.get_tag.outputs.sha_short }} # [å¼•ç”¨è®Šæ•¸]
        run: |                                       # [è¨»è§£] åŸ·è¡Œè…³æœ¬
          FULL_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}" # [æŒ‡ä»¤]
          docker build -t ${FULL_PATH}:${SHA} -t ${FULL_PATH}:v2 . # [æŒ‡ä»¤]ï¼šåŒæ™‚æ‰“ä¸Š SHA èˆ‡ v2 å…©å€‹æ¨™ç±¤
          docker push ${FULL_PATH}:${SHA}             # [æŒ‡ä»¤]ï¼šæ¨é€æ˜ åƒæª”
          docker push ${FULL_PATH}:v2                 # [æŒ‡ä»¤]ï¼šæ¨é€æ˜ åƒæª”

      - name: Get GKE Credentials                    # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šç²å–å¢é›†æ†‘è­‰
        uses: google-github-actions/get-gke-credentials@v1 # [å¼•ç”¨]
        with:                                        # [åƒæ•¸]
          cluster_name: ${{ env.GKE_CLUSTER }}       # [åƒæ•¸]
          location: ${{ env.GKE_ZONE }}              # [åƒæ•¸]

      - name: Deploy Canary Only                     # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šåŸ·è¡Œé‡‘çµ²é›€ç™¼ä½ˆ
        run: |                                       # [è¨»è§£] åŸ·è¡ŒæŒ‡ä»¤
          kubectl apply -f k8s/canary-deployment.yaml # [æŒ‡ä»¤]ï¼šå•Ÿå‹• v2 æ¸¬è©¦ç‰ˆ Pods
          kubectl rollout restart deployment pca-app-canary -n pca-app-ns # [æŒ‡ä»¤]ï¼šå¼·åˆ¶é‡å•Ÿä»¥å¥—ç”¨æ–°æ˜ åƒæª”

      - name: Notify Telegram (Canary Released)       # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šç™¼é€é‡‘çµ²é›€ä¸Šç·šå‘Šè­¦
        if: success()                                # [åˆ¤æ–·]ï¼šæˆåŠŸæ™‚åŸ·è¡Œ
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}          # [åƒæ•¸]
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}      # [åƒæ•¸]
        run: |                                       # [è¨»è§£] åŸ·è¡ŒæŒ‡ä»¤
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}') # [æŒ‡ä»¤]
          MSG="ğŸ¤ [Canary Live] v2 å·²ä¸Šç·šï¼%0AğŸŒ æ¸¬è©¦ç¶²å€: http://${APP_IP}%0Aè«‹è§€å¯Ÿç›£æ§æ•¸æ“šæ¯”å° v1 èˆ‡ v2ã€‚" # [å…§å®¹]
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG" # [æŒ‡ä»¤]

  # ================================================================================================= # [å€éš”ç·š] Job 3 å€éš”ç·š
  # Job 3: å…¨é¢åˆ‡æ› (Full Rollout)                                                                        # [å‚™è¨»] ç•¶ç¢ºèª v2 ç©©å®šå¾Œï¼Œå°‡å…¨æ•¸æµé‡åˆ‡æ›
  # ================================================================================================= # [å€éš”ç·š]
  full-rollout:                                      # [ä»»å‹™ ID]
    name: Approval & Full Rollout                    # [ä»»å‹™åç¨±]
    needs: deploy-canary                             # [è¨»è§£] è¨­å®šä¾è³´ï¼šå¿…é ˆç­‰é‡‘çµ²é›€ Job å®Œæˆæ‰å•Ÿå‹•
    runs-on: ubuntu-latest                           # [åŸ·è¡Œå™¨]
    environment: production                          # [è¨»è§£] ç¬¬äºŒé“é–˜é–€ï¼šç”Ÿç”¢ç’°å¢ƒæ ¸å‡†
    steps:                                           # [æ­¥é©Ÿæ¸…å–®]
      - name: Checkout Code                          # [æ­¥é©Ÿæ¨™é¡Œ]
        uses: actions/checkout@v3                    # [å¼•ç”¨]

      - name: Authenticate to GCP                    # [æ­¥é©Ÿæ¨™é¡Œ]
        uses: google-github-actions/auth@v1          # [å¼•ç”¨]
        with:                                        # [åƒæ•¸]
          credentials_json: ${{ secrets.GCP_SA_KEY }} # [åƒæ•¸]

      - name: Get GKE Credentials                    # [æ­¥é©Ÿæ¨™é¡Œ]
        uses: google-github-actions/get-gke-credentials@v1 # [å¼•ç”¨]
        with:                                        # [åƒæ•¸]
          cluster_name: ${{ env.GKE_CLUSTER }}       # [åƒæ•¸]
          location: ${{ env.GKE_ZONE }}              # [åƒæ•¸]

      - name: Full Rollout (v2)                      # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šåŸ·è¡Œå…¨é¢åˆ‡æ›è‡³æ­£å¼ç‰ˆ
        run: |                                       # [è¨»è§£] åŸ·è¡ŒæŒ‡ä»¤
          kubectl apply -f k8s/app-green.yaml        # [æŒ‡ä»¤]ï¼šéƒ¨ç½²æ­£å¼çš„ v2 æ­£å¼ç‰ˆ (Green)
          kubectl patch svc pca-app-service -n pca-app-ns -p "{\"spec\":{\"selector\":{\"version\":\"v2\"}}}" # [æŒ‡ä»¤]ï¼šé€é Patch ç¬é–“åˆ‡æ› Selector
          kubectl delete -f k8s/canary-deployment.yaml --ignore-not-found=true # [æŒ‡ä»¤]ï¼šæ¸…ç†æš«å­˜çš„é‡‘çµ²é›€ Pods

      - name: Notify Telegram (Success)               # [æ­¥é©Ÿæ¨™é¡Œ]ï¼šæœ€çµ‚éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()                                # [åˆ¤æ–·]
        env:                                         # [ç’°å¢ƒè®Šæ•¸]
          TG_TOKEN: ${{ secrets.TG_TOKEN }}          # [åƒæ•¸]
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}      # [åƒæ•¸]
        run: |                                       # [è¨»è§£] åŸ·è¡ŒæŒ‡ä»¤
          APP_IP=$(kubectl get svc pca-app-service -n pca-app-ns -o jsonpath='{.status.loadBalancer.ingress[0].ip}') # [æŒ‡ä»¤]
          MSG="ğŸš€ [Full Rollout] 100% åˆ‡æ›è‡³ v2 å®Œæˆï¼" # [æŒ‡ä»¤]å…§å®¹
          curl -f -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" -d chat_id="${TG_CHAT_ID}" -d text="$MSG" # [æŒ‡ä»¤]