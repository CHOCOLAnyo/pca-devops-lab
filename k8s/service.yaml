#k8s/service.yaml
# -------------------------------------------------------------------------------------
# 資源名稱：金絲雀流量控制器 (Service)
# 核心功能：這是金絲雀部署的「分流總機」。透過移除版本限制，讓流量隨機打向 v1 與 v2。
# -------------------------------------------------------------------------------------
apiVersion: v1                 # [固定] K8s API 版本
kind: Service                  # [固定] 資源類型：負責負載平衡
metadata:                      # [元數據]
  name: pca-app-service        # [名稱] 對外服務名稱，不管是 v1 還是 v2 流量，都從這裡進來
  namespace: pca-app-ns        # [空間] 必須與 Deployment 所在的空間一致
spec:                          # [規格說明]
  # -----------------------------------------------------------------------------------
  # 流量暴露模式 (Ingress Type)
  # -----------------------------------------------------------------------------------
  type: LoadBalancer           # [類型] 向雲端平台 (GCP) 申請實體 External IP，方便面試展示
  
  # -----------------------------------------------------------------------------------
  # [SRE 核心修正] 流量選擇器 (Selector)
  # -----------------------------------------------------------------------------------
  selector:                    # [關鍵邏輯] 定義總機要將流量轉發給哪些標籤的 Pod
    app: pca-app               # 🔥 [修正點] 只鎖定 app 名稱，故意移除 version 標籤
                               # [原理] 因為 v1 和 v2 的 Pod 同時都擁有 app=pca-app 這個標籤
                               # [結果] Service 會同時發現 3 個 IP (2 舊 + 1 新)，流量實現隨機分配
  
  # -----------------------------------------------------------------------------------
  # 端口映射 (Port Mapping)
  # -----------------------------------------------------------------------------------
  ports:                       # [埠號配置]
    - protocol: TCP            # [協定] 採用 TCP
      port: 80                 # [對外埠號] 使用者訪問的 Port (標準 HTTP 埠)
      targetPort: 5000         # [對內埠號] 流量轉發至容器內 Flask 程式監聽的 5000 Port